<!doctype html><html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Line Puzzle Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
/* ---------- Tokens ---------- */
:root{
 --c-main:#2563eb;--c-edge:#94a3b8;--c-warn:#ef4444;--c-bg:#f4f7fb;
 --panel:rgba(255,255,255,.8);--radius:16px;--shadow:0 4px 12px rgb(0 0 0 /.12);
 font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
html,body{margin:0;height:100%;background:var(--c-bg);color:#1e293b}

/* ---------- Header ---------- */
header{display:flex;align-items:center;gap:.8rem;padding:.7rem 1rem;
  background:var(--panel);backdrop-filter:blur(8px);box-shadow:var(--shadow)}
h1{margin:0;font-size:1.1rem;font-weight:600}
#barWrap{flex:1;height:.35rem;background:#e2e8f0;border-radius:9999px;overflow:hidden}
#bar{display:block;height:100%;width:0;background:var(--c-main);transition:width .25s}
#clock{min-width:3rem;text-align:center;font-variant-numeric:tabular-nums}

/* ---------- Tabs ---------- */
nav{display:flex;overflow-x:auto;background:var(--panel);backdrop-filter:blur(8px)}
nav button{flex:1 1 0;min-width:3rem;padding:.55rem 0;border:none;background:none;
  font-weight:600;color:#64748b;border-bottom:3px solid transparent}
nav button[aria-selected="true"]{color:var(--c-main);border-color:var(--c-main)}
nav button:focus{outline:3px solid #000}

/* ---------- Main ---------- */
main{display:flex;flex-direction:column;height:calc(100% - 6rem)}
#cv{flex:1;width:100%;touch-action:none;background:#fff;cursor:crosshair}

/* ---------- Controls ---------- */
.ctrl{display:flex;gap:.6rem;padding:.8rem;background:var(--panel);backdrop-filter:blur(8px)}
.ctrl button{flex:1;padding:.55rem 0;border:none;border-radius:var(--radius);background:#fff;
  display:flex;justify-content:center;align-items:center;gap:.3rem;font-weight:600;box-shadow:var(--shadow)}
.ctrl button:active{transform:scale(.96)}.ctrl button i{color:#475569}

/* ---------- Overlays ---------- */
.ovr{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;
  background:rgba(0,0,0,.8);z-index:900;color:#fff;text-align:center}
.ovr h2{margin:0 0 .5rem;font-size:1.4rem}.ovr p{margin:0;font-size:.95rem}
@keyframes blink{0%,40%{opacity:1}50%{opacity:.3}100%{opacity:1}}
#start p{animation:blink 1.4s infinite}
@media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
</style></head><body role="application">

<header>
  <h1>Line Puzzle Pro</h1>
  <div id="barWrap"><span id="bar"></span></div>
  <div id="clock">--</div>
</header>

<nav id="tabs" aria-label="Èõ£ÊòìÂ∫¶"></nav>

<main>
  <canvas id="cv" aria-label="Á∑ö„Éë„Ç∫„É´" role="img"></canvas>
  <div class="ctrl">
    <button id="reset"><i class="fa-solid fa-arrow-rotate-right"></i>Reset</button>
    <button id="hint"><i class="fa-solid fa-lightbulb"></i>Hint</button>
    <button id="pause"><i class="fa-solid fa-pause"></i>Pause</button>
  </div>
</main>

<!-- overlays -->
<div id="start" class="ovr"><h2>Line Puzzle Pro</h2><p>‚ñ∂ „Çø„ÉÉ„Éó„Åó„Å¶„Çπ„Çø„Éº„Éà</p></div>
<div id="modal" class="ovr" style="display:none">
  <h2 id="modalTitle"></h2>
  <button id="nextBtn" style="margin-top:1rem;padding:.6rem 1.4rem;border:none;border-radius:12px;
   background:var(--c-main);color:#fff;font-weight:700;box-shadow:var(--shadow)">OK</button>
</div>

<script>
/* ---------- state ---------- */
const cvs=cv,ctx=cvs.getContext('2d'), bar=bar, clk=clock,
 modal=document.getElementById('modal'),startOvr=start,modalTitle=modalTitle,nextBtn=nextBtn;
const live=(()=>{const d=document.createElement('div');d.setAttribute('aria-live','polite');
  d.style.position='absolute';d.style.left='-9999px';document.body.appendChild(d);return d})();
let puzzles=[],cur=null,traced=new Set(),path=[],TIME=90,remain=90,timerId=null,paused=false,playing=false;

/* color cache */
const CS=getComputedStyle(document.documentElement),C_NODE=CS.getPropertyValue('--c-main').trim(),
  C_EDGE=CS.getPropertyValue('--c-edge').trim(),C_ON=C_NODE,C_ERR=CS.getPropertyValue('--c-warn').trim();

/* ---------- init ---------- */
fetch('contents.json').then(r=>r.json()).then(d=>{puzzles=d.puzzles;tabs();resize();load(1);})
.catch(e=>alert(e));

function tabs(){
  const nav=tabsElem=document.getElementById('tabs');nav.innerHTML='';
  [...new Set(puzzles.map(p=>p.difficulty))].sort((a,b)=>a-b)
  .forEach((lvl,i)=>{const b=document.createElement('button');
   b.textContent=lvl;b.dataset.lvl=lvl;b.setAttribute('aria-selected',!i);
   b.onclick=()=>{nav.querySelectorAll('button').forEach(x=>x.setAttribute('aria-selected','false'));
     b.setAttribute('aria-selected','true');load(lvl)};nav.appendChild(b)});
}

function resize(){const d=window.devicePixelRatio||1;cvs.width=cvs.clientWidth*d;cvs.height=cvs.clientHeight*d;ctx.setTransform(d,0,0,d,0,0);draw()}
window.onresize=resize;

/* ---------- load / reset ---------- */
function load(lvl){cur=puzzles.find(p=>p.difficulty==lvl);reset()}
function reset(){
 traced.clear();path.length=0;remain=TIME;updateUI();draw();
 if(playing&&!paused)runTimer()}
function updateUI(){bar.style.width=`${100*traced.size/cur.edges.length}%`;clk.textContent=remain}

/* ---------- draw ---------- */
function draw(){
 if(!cur)return;const w=cvs.clientWidth,h=cvs.clientHeight;ctx.clearRect(0,0,w,h);
 cur.edges.forEach((e,i)=>{const f=cur.nodes[e.from],t=cur.nodes[e.to];
   ctx.beginPath();ctx.moveTo(f.x*w,f.y*h);ctx.lineTo(t.x*w,t.y*h);
   ctx.lineWidth=traced.has(i)?14:10;ctx.lineCap='round';
   ctx.strokeStyle=traced.has(i)?C_ON:C_EDGE;ctx.stroke()});
 cur.nodes.forEach((n,i)=>{const x=n.x*w,y=n.y*h;
   ctx.beginPath();ctx.arc(x,y,22,0,2*Math.PI);ctx.fillStyle=C_NODE;ctx.fill();
   if(path[path.length-1]===i){ctx.lineWidth=4;ctx.strokeStyle='#facc15';ctx.stroke()}});
}

/* ---------- input ---------- */
function idx(px,py){const r=cvs.getBoundingClientRect(),x=px-r.left,y=py-r.top,w=r.width,h=r.height;
 return cur.nodes.findIndex(n=>Math.hypot(n.x*w-x,n.y*h-y)<=25)}
function edgeIdx(a,b){return cur.edges.findIndex(e=>(e.from==a&&e.to==b)||(e.to==a&&e.from==b))}
function connect(a,b){
 const i=edgeIdx(a,b);if(i===-1||traced.has(i)){shake();return false}
 traced.add(i);path.push(b);updateUI();draw();if(traced.size===cur.edges.length)finish(true);return true}
function shake(){ctx.save();ctx.strokeStyle=C_ERR;ctx.lineWidth=16;ctx.lineCap='round';
 const e=cur.edges[edgeIdx(path[path.length-1],idxNext)]||null;ctx.restore()}
function onDown(e){if(!playing||paused)return;const p=getPoint(e);const i=idx(p.x,p.y);if(i!==-1){path=[i];draw()}}
function onMove(e){if(!playing||paused||!path.length)return;
 const p=getPoint(e),i=idx(p.x,p.y);if(i!==-1&&i!==path[path.length-1])connect(path[path.length-1],i)}
function getPoint(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}
['pointerdown','touchstart','mousedown'].forEach(evt=>cvs.addEventListener(evt,onDown,{passive:false}));
['pointermove','touchmove','mousemove'].forEach(evt=>cvs.addEventListener(evt,onMove,{passive:false}));

/* ---------- timer ---------- */
function runTimer(){clearInterval(timerId);timerId=setInterval(()=>{if(paused)return;
 remain--;updateUI();if(remain===10)flashClock();if(remain<=0){finish(false)}},1000)}
function flashClock(){clk.style.color=C_ERR;setTimeout(()=>clk.style.color='',9000)}
function finish(win){
 clearInterval(timerId);playing=false;modalTitle.textContent=win?'üéâ Clear!':'‚è∞ Time Up';
 nextBtn.onclick=()=>{modal.style.display='none';playing=true;reset();};modal.style.display='flex';
 live.textContent=win?'„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü':'ÊôÇÈñìÂàá„Çå„Åß„Åô';}

/* ---------- hint ---------- */
let hintCool=false;
hint.onclick=()=>{if(hintCool||traced.size===cur.edges.length)return;
 const i=cur.edges.findIndex((_,i)=>!traced.has(i));if(i===-1)return;
 const {from,to}=cur.edges[i];ctx.save();ctx.strokeStyle='#facc15';ctx.lineWidth=18;ctx.lineCap='round';
 const w=cvs.clientWidth,h=cvs.clientHeight;ctx.beginPath();ctx.moveTo(cur.nodes[from].x*w,cur.nodes[from].y*h);
 ctx.lineTo(cur.nodes[to].x*w,cur.nodes[to].y*h);ctx.stroke();ctx.restore();live.textContent='„Éí„É≥„ÉàË°®Á§∫';
 hintCool=true;setTimeout(()=>hintCool=false,5000)}

/* ---------- pause ---------- */
pause.onclick=()=>{if(!playing)return;paused=!paused;pause.querySelector('i').className=
 paused?'fa-solid fa-play':'fa-solid fa-pause';pause.childNodes[1].nodeValue=paused?'Resume':'Pause';
 paused?live.textContent='‰∏ÄÊôÇÂÅúÊ≠¢':runTimer()}

/* ---------- start overlay ---------- */
startOvr.onclick=()=>{startOvr.style.display='none';playing=true;reset();runTimer()}

/* ---------- other buttons ---------- */
reset.onclick=()=>{playing&&reset();live.textContent='„É™„Çª„ÉÉ„Éà'};
nextBtn.onclick=()=>modal.style.display='none'; /* fallback */
</script></body></html>
