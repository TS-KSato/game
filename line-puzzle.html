<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Line Puzzle ‚Äì Swipe Edition</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
/* ============  TOKENS  ============ */
:root{
  --clr-bg:            #f4f7fb;
  --clr-panel:         rgba(255,255,255,.75);
  --clr-node:          #2563eb;
  --clr-edge:          #94a3b8;
  --clr-edge-traced:   #2563eb;
  --clr-edge-glow:     rgba(37,99,235,.45);
  --radius:            16px;
  --shadow:            0 4px 12px rgba(0,0,0,.12);
  --focus:             3px solid #000;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
/* ============  LAYOUT  ============ */
html,body{margin:0;height:100%;background:var(--clr-bg);color:#1e293b}
header{
  display:flex;align-items:center;gap:.8rem;
  padding:.7rem 1rem;background:var(--clr-panel);backdrop-filter:blur(8px);box-shadow:var(--shadow)
}
h1{margin:0;font-size:1.1rem;font-weight:600}
#info{flex:1;display:flex;gap:.6rem;align-items:center;font-size:.85rem}
#progress{flex:1;height:.35rem;background:#e2e8f0;border-radius:9999px;overflow:hidden}
#progress span{display:block;height:100%;width:0;background:var(--clr-node);transition:width .25s}
#timer{min-width:2.6rem;text-align:center;font-variant-numeric:tabular-nums}

nav{display:flex;overflow-x:auto;background:var(--clr-panel);backdrop-filter:blur(8px)}
nav button{
  flex:1 1 0;min-width:3.2rem;padding:.6rem 0;border:none;background:none;font-weight:600;
  border-bottom:3px solid transparent;color:#475569
}
nav button[aria-selected="true"]{border-color:var(--clr-node);color:var(--clr-node)}
nav button:focus{outline:var(--focus)}

main{display:flex;flex-direction:column;height:calc(100% - 6rem)}
#canvas{flex:1;width:100%;touch-action:none;background:#fff;cursor:crosshair}

.controls{display:flex;gap:.6rem;padding:.8rem;background:var(--clr-panel);backdrop-filter:blur(8px)}
.controls button{
  flex:1;padding:.55rem 0;border:none;border-radius:var(--radius);background:#fff;
  display:flex;justify-content:center;align-items:center;gap:.3rem;font-weight:600;
  box-shadow:var(--shadow);transition:transform .12s;
}
.controls button:active{transform:scale(.96)}
.controls button i{font-size:.9rem;color:#475569}

/* ---- overlay ---- */
#overlay{
  position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;
  background:rgba(0,0,0,.7);z-index:999;color:#fff;text-align:center;
}
#overlay h2{margin:0 0 .5rem;font-size:1.4rem}
#overlay p{margin:0;font-size:.95rem;animation:blink 1.4s infinite}
@keyframes blink{0%,40%{opacity:1}50%{opacity:.35}100%{opacity:1}}
@media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
</style>
</head>
<body role="application">

<header>
  <h1>Line Puzzle</h1>
  <div id="info">
    <div id="progress"><span></span></div>
    <div id="timer">--</div>
  </div>
</header>

<nav id="tabs" aria-label="Èõ£ÊòìÂ∫¶"></nav>

<main>
  <canvas id="canvas" aria-label="Á∑ö„Éë„Ç∫„É´" role="img"></canvas>
  <div class="controls">
    <button id="resetBtn"><i class="fa-solid fa-arrow-rotate-right"></i>Reset</button>
    <button id="hintBtn"><i class="fa-solid fa-lightbulb"></i>Hint</button>
    <button id="timerBtn" aria-pressed="true"><i class="fa-solid fa-stopwatch"></i>Timer On</button>
  </div>
</main>

<div id="overlay" role="dialog" aria-modal="true">
  <h2>Line Puzzle</h2>
  <p>‚ñ∂ „Çø„ÉÉ„Éó„Åó„Å¶„Çπ„Çø„Éº„Éà</p>
</div>

<script>
/* ========== STATE ========= */
const cvs=document.getElementById('canvas'), ctx=cvs.getContext('2d');
const bar=document.querySelector('#progress span'), timerTxt=document.getElementById('timer');
const announcer=(()=>{const d=document.createElement('div');d.setAttribute('aria-live','polite');d.style.position='absolute';d.style.left='-9999px';document.body.appendChild(d);return d})();
let puzzles=[], cur=null, traced=new Set(), path=[], timer=90, tLeft=90, tId, timerOn=true, playing=false;

/* colors 1√óÂèñÂæó */
const rs=getComputedStyle(document.documentElement);
const C_NODE=rs.getPropertyValue('--clr-node').trim();
const C_EDGE=rs.getPropertyValue('--clr-edge').trim();
const C_EDGE_ON=rs.getPropertyValue('--clr-edge-traced').trim();
const GLOW=rs.getPropertyValue('--clr-edge-glow').trim();

/* ========== LOAD JSON & INIT ========= */
fetch('contents.json').then(r=>r.json()).then(d=>{puzzles=d.puzzles;buildTabs();resize();load(1);})
.catch(e=>alert('JSON error\n'+e));

/* ========== UI BUILD ========= */
function buildTabs(){
  const tabs=document.getElementById('tabs'); tabs.innerHTML='';
  [...new Set(puzzles.map(p=>p.difficulty))].sort((a,b)=>a-b).forEach((lvl,i)=>{
    const b=document.createElement('button');
    b.textContent=lvl; b.dataset.lvl=lvl; b.setAttribute('aria-selected',!i);
    b.onclick=()=>{document.querySelectorAll('#tabs button').forEach(x=>x.setAttribute('aria-selected','false'));b.setAttribute('aria-selected','true');load(lvl);};
    tabs.appendChild(b);
  });
}

/* ========== CANVAS ========= */
function resize(){
  const dpr=window.devicePixelRatio||1; cvs.width=cvs.clientWidth*dpr; cvs.height=cvs.clientHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0); render();
}
window.addEventListener('resize',resize);

/* ========== LOAD PUZZLE ========= */
function load(lvl){
  cur = puzzles.find(p=>p.difficulty==lvl) || puzzles[0];
  traced.clear(); path.length=0; tLeft=timer; updateProgress(); render();
  if(playing) startTimer();
}
function reset(){traced.clear();path.length=0;tLeft=timer;updateProgress();render();if(playing)startTimer();}

/* ========== DRAW ========= */
function render(){
  if(!cur) return;
  const w=cvs.clientWidth,h=cvs.clientHeight; ctx.clearRect(0,0,w,h);
  /* edges */
  cur.edges.forEach((e,i)=>{
    const f=cur.nodes[e.from],t=cur.nodes[e.to];
    ctx.beginPath();ctx.moveTo(f.x*w,f.y*h);ctx.lineTo(t.x*w,t.y*h);
    ctx.lineWidth= traced.has(i)?14:10; ctx.lineCap='round';
    ctx.strokeStyle=traced.has(i)?C_EDGE_ON:C_EDGE;
    if(traced.has(i)){ctx.shadowBlur=6;ctx.shadowColor=GLOW;}else ctx.shadowBlur=0;
    ctx.stroke();
  });
  /* nodes */
  cur.nodes.forEach((n,idx)=>{
    const x=n.x*w,y=n.y*h; ctx.beginPath();ctx.arc(x,y,22,0,2*Math.PI);
    ctx.fillStyle=C_NODE; ctx.fill();
    /* outline */
    ctx.lineWidth=4; ctx.strokeStyle='#fff'; ctx.stroke();
    /* active pop */
    if(path[path.length-1]===idx){
      ctx.save();ctx.lineWidth=4;ctx.strokeStyle='#facc15';ctx.stroke();ctx.restore();
    }
  });
}

/* ========== INPUT (swipe) ========= */
function getIdx(px,py){
  const r=cvs.getBoundingClientRect(),x=px-r.left,y=py-r.top,w=r.width,h=r.height;
  return cur.nodes.findIndex(n=>Math.hypot(n.x*w-x,n.y*h-y)<=25);
}
function connect(a,b){
  const i=cur.edges.findIndex(e=>(e.from==a&&e.to==b)||(e.to==a&&e.from==b));
  if(i===-1||traced.has(i)) return false;
  traced.add(i); path.push(b); updateProgress(); render();
  if(traced.size===cur.edges.length){announce('üéâ„ÇØ„É™„Ç¢ÔºÅ');stopTimer();}
  return true;
}
function onDown(e){if(!playing)return;const{clientX:x,clientY:y}=e.touches?e.touches[0]:e;const idx=getIdx(x,y);if(idx!==-1){path=[idx];render();}}
function onMove(e){
  if(!playing||!path.length)return;
  const{clientX:x,clientY:y}=e.touches?e.touches[0]:e;
  const idx=getIdx(x,y); if(idx===-1||idx===path[path.length-1]) return;
  connect(path[path.length-1],idx);
}
['pointerdown','touchstart','mousedown'].forEach(evt=>cvs.addEventListener(evt,onDown,{passive:false}));
['pointermove','touchmove','mousemove'].forEach(evt=>cvs.addEventListener(evt,onMove,{passive:false}));

/* ========== PROGRESS & TIMER ========= */
function updateProgress(){
  bar.style.width=`${100*traced.size/cur.edges.length}%`;
  timerTxt.textContent=tLeft;
}
function startTimer(){
  clearInterval(tId); updateProgress();
  if(!timerOn) return;
  tId=setInterval(()=>{tLeft--;updateProgress();if(tLeft<=0){stopTimer();announce('‚è∞Time up');}},1000);
}
function stopTimer(){clearInterval(tId);}
document.getElementById('timerBtn').onclick=e=>{
  timerOn=!timerOn; e.target.setAttribute('aria-pressed',timerOn);
  e.target.querySelector('i').className=timerOn?'fa-solid fa-stopwatch':'fa-solid fa-ban';
  e.target.childNodes[1].nodeValue=timerOn?'Timer On':'Timer Off';
  timerOn?startTimer():stopTimer();
};

/* ========== BUTTONS ========= */
document.getElementById('overlay').onclick=()=>{document.getElementById('overlay').style.display='none';playing=true;reset();};
document.getElementById('resetBtn').onclick=()=>playing&&reset();
document.getElementById('hintBtn').onclick=()=>{
  const i=cur.edges.findIndex((_,i)=>!traced.has(i)); if(i===-1)return;
  const n=cur.edges[i].from; path=[n]; render(); announce('„Éí„É≥„Éà: Ê¨°„ÅÆÁ∑ö„ÇíÊé¢„Åù„ÅÜ');
};

/* ========== ARIA announce ========= */
function announce(msg){announcer.textContent=msg;}
</script>
</body>
</html>
